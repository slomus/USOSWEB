apiVersion: v1
kind: ConfigMap
metadata:
  name: seed-sql-scripts
  namespace: usosweb
data:
  mock_data.sql: |
    TRUNCATE TABLE
        module_subjects,
        course_subjects,
        student_classes,
        course_instructors,
        surveys,
        applications,
        attachments,
        message_recipients,
        messages,
        classes,
        modules,
        courses,
        teaching_staff,
        administrative_staff,
        students,
        subjects,
        buildings,
        faculties,
        users
    RESTART IDENTITY CASCADE;

    INSERT INTO faculties (name) VALUES
    ('Wydzia≈Ç Informatyki'),
    ('Wydzia≈Ç Matematyki'), 
    ('Wydzia≈Ç Fizyki'),
    ('Wydzia≈Ç Mechatroniki');

    INSERT INTO buildings (name, address) VALUES
    ('Budynek G≈Ç√≥wny', 'ul. J.K.Chodkiewicza 30, Bydgoszcz'),
    ('Instytut Informatyki', 'ul. Kopernika 1, Bydgoszcz'),
    ('Laboratorium Fizyczne', 'ul. Weyssenhoffa 11, Bydgoszcz'),
    ('Biblioteka Centralna', 'ul. Karola Szymanowskiego 3, Bydgoszcz'),
    ('Instytut Mechatroniki', 'ul. Kopernika 1, Bydgoszcz'),
    ('Centrum Jƒôzyk√≥w Obcych', 'ul. Chodkiewicza 30, Bydgoszcz'),
    ('Wydzial Matematyki - budynek A', 'ul. Fordo≈Ñska 123, Bydgoszcz'),
    ('Centrum Sportowe', 'ul. Sportowa 2, Bydgoszcz');

    INSERT INTO application_categories (name, description, application_start_date, application_end_date, active) VALUES
    ('Stypendium socjalne', 'Wniosek o stypendium socjalne', '2024-09-01 00:00:00', '2026-09-30 23:59:59', true),
    ('Urlop dzieka≈Ñski', 'Wniosek o urlop dzieka≈Ñski', '2024-09-15 00:00:00', '2026-10-31 23:59:59', true),
    ('Zapomoga', 'Wniosek o jednorazowƒÖ zapomogƒô', '2024-09-15 00:00:00', '2026-10-31 23:59:59', true),
    ('Stypendium naukowe', 'Wniosek o stypendium za wyniki w nauce', '2024-09-01 00:00:00', '2026-10-15 23:59:59', true),
    ('Wymiana zagraniczna', 'Wniosek o wyjazd na wymianƒô studenckƒÖ', '2024-10-01 00:00:00', '2026-03-31 23:59:59', true)
    ON CONFLICT (name) DO NOTHING;

  init_relations.sql: |
    DO $$
    BEGIN
        IF (SELECT COUNT(*) FROM users) < 8 THEN
            RAISE EXCEPTION 'U≈ºytkownicy nie zostali jeszcze stworzeni! Uruchom najpierw init-users script.';
        END IF;
        RAISE NOTICE 'Znaleziono % u≈ºytkownik√≥w. Populujƒô relacje...', (SELECT COUNT(*) FROM users);
    END $$;

    INSERT INTO messages (sender_id, title, content, send_date) VALUES
    (
        (SELECT user_id FROM users WHERE email = 'agnieszka.kowalik@edu.pl'),
        'Rozpoczƒôcie semestru',
        'Witam wszystkich student√≥w na pierwszych zajƒôciach z Programowania 1. Proszƒô o przygotowanie ≈õrodowiska programistycznego.',
        '2024-10-01 10:00:00'
    ),
    (
        (SELECT user_id FROM users WHERE email = 'weronika.mazurek@edu.pl'),
        'Harmonogram egzamin√≥w',
        'Informujƒô o terminach egzamin√≥w z Matematyki 1. Szczeg√≥≈Çy w za≈ÇƒÖczniku.',
        '2024-10-02 14:30:00'
    ),
    (
        (SELECT user_id FROM users WHERE email = 'agnieszka.kowalik@edu.pl'),
        'Zmiana godzin w dziekanacie',
        'Od przysz≈Çego tygodnia dziekanat bƒôdzie czynny w godzinach 8:00-15:00.',
        '2024-10-03 09:15:00'
    ),
    (
        (SELECT user_id FROM users WHERE email = 'kacper.pawlak@edu.pl'),
        'Laboratorium z Fizyki',
        'Przypominam o obowiƒÖzku przynoszenia kalkulatora na zajƒôcia laboratoryjne.',
        '2024-10-04 11:20:00'
    )
    ON CONFLICT DO NOTHING;

    INSERT INTO message_recipients (message_id, recipient_id, read_at) VALUES
    (1, (SELECT user_id FROM users WHERE email = 'michal.grzonkowski@student.edu.pl'), '2024-10-01 12:30:00'),
    (1, (SELECT user_id FROM users WHERE email = 'jan.kowalski@student.edu.pl'), NULL),
    (1, (SELECT user_id FROM users WHERE email = 'anna.nowak@student.edu.pl'), '2024-10-01 15:45:00'),
    (2, (SELECT user_id FROM users WHERE email = 'michal.grzonkowski@student.edu.pl'), '2024-10-02 16:00:00'),
    (2, (SELECT user_id FROM users WHERE email = 'jan.kowalski@student.edu.pl'), '2024-10-02 17:30:00'),
    (2, (SELECT user_id FROM users WHERE email = 'anna.nowak@student.edu.pl'), NULL),
    (3, (SELECT user_id FROM users WHERE email = 'michal.grzonkowski@student.edu.pl'), NULL),
    (3, (SELECT user_id FROM users WHERE email = 'jan.kowalski@student.edu.pl'), NULL),
    (3, (SELECT user_id FROM users WHERE email = 'anna.nowak@student.edu.pl'), NULL),
    (3, (SELECT user_id FROM users WHERE email = 'emil.kosicki@edu.pl'), '2024-10-03 10:00:00'),
    (3, (SELECT user_id FROM users WHERE email = 'weronika.mazurek@edu.pl'), '2024-10-03 10:15:00'),
    (4, (SELECT user_id FROM users WHERE email = 'michal.grzonkowski@student.edu.pl'), NULL),
    (4, (SELECT user_id FROM users WHERE email = 'jan.kowalski@student.edu.pl'), '2024-10-04 12:00:00'),
    (4, (SELECT user_id FROM users WHERE email = 'anna.nowak@student.edu.pl'), '2024-10-04 13:30:00')
    ON CONFLICT DO NOTHING;

    INSERT INTO attachments (message_id, filename, original_filename, file_size, mime_type, file_path) VALUES
    (2, '20241002_harmonogram_egzaminow.pdf', 'Harmonogram egzamin√≥w MAT1.pdf', 245760, 'application/pdf', '/uploads/2024/10/02/20241002_harmonogram_egzaminow.pdf'),
    (1, '20241001_srodowisko_prog.zip', 'Instrukcja instalacji ≈õrodowiska.zip', 1048576, 'application/zip', '/uploads/2024/10/01/20241001_srodowisko_prog.zip'),
    (4, '20241004_instrukcja_lab.docx', 'Instrukcja laboratorium fizyka.docx', 524288, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', '/uploads/2024/10/04/20241004_instrukcja_lab.docx')
    ON CONFLICT DO NOTHING;

    INSERT INTO applications (category_id, album_nr, title, content, status) VALUES
    (1, 1, 'Wniosek o stypendium socjalne', 'Proszƒô o przyznanie stypendium socjalnego na semestr zimowy.', 'submitted'),
    (2, 2, 'Wniosek o urlop dzieka≈Ñski', 'Proszƒô o udzielenie urlopu dzieka≈Ñskiego z powod√≥w zdrowotnych.', 'submitted')
    ON CONFLICT DO NOTHING;

    INSERT INTO surveys (class_id, question, mark) VALUES
    (1, 'Jak oceniasz przydatno≈õƒá wyk≈Çadu?', 4),
    (1, 'Czy tempo prowadzenia zajƒôƒá by≈Ço odpowiednie?', 5),
    (2, 'Jak oceniasz jako≈õƒá materia≈Ç√≥w laboratoryjnych?', 3),
    (4, 'Czy wyk≈Çad by≈Ç zrozumia≈Çy?', 5),
    (5, 'Jak oceniasz trudno≈õƒá ƒáwicze≈Ñ?', 4)
    ON CONFLICT DO NOTHING;

    INSERT INTO course_instructors (class_id, teaching_staff_id) VALUES
    (1, 1), (2, 1), (3, 1), (4, 3), (5, 2), (6, 1), (7, 1)
    ON CONFLICT DO NOTHING;

    INSERT INTO student_classes (class_id, album_nr) VALUES
    (1, 1), (2, 1), (3, 1), (4, 1),
    (1, 2), (2, 2), (3, 2), (4, 2), (6, 2),
    (1, 3), (5, 3)
    ON CONFLICT DO NOTHING;

    INSERT INTO grades (album_nr, class_id, subject_id, value, weight, attempt, added_by_teaching_staff_id, comment, created_at) VALUES
    (1, 1, 1, '4.5', 1, 1, 1, 'Bardzo dobra znajomo≈õƒá podstaw programowania', '2024-12-15 10:30:00'),
    (1, 2, 1, '4.0', 1, 1, 1, 'Poprawnie wykonane zadania laboratoryjne', '2024-12-10 14:45:00'),
    (1, 3, 4, '4.5', 1, 1, 1, '≈öwietne zrozumienie algorytm√≥w', '2024-12-12 11:20:00'),
    (1, 4, 5, '3.5', 1, 1, 3, 'Zaliczone, ale wymaga wiƒôcej pracy z teoriƒÖ', '2024-12-08 16:00:00'),
    (2, 1, 1, '3.0', 1, 1, 1, 'Podstawowa znajomo≈õƒá, potrzebuje wiƒôcej praktyki', '2024-12-15 10:35:00'),
    (2, 2, 1, '3.5', 1, 1, 1, 'Zadania wykonane poprawnie, ale bez inwencji', '2024-12-10 14:50:00'),
    (2, 3, 4, '3.0', 1, 1, 1, 'Minimum programowe zaliczone', '2024-12-12 11:25:00'),
    (2, 4, 5, '4.0', 1, 1, 3, 'Dobra znajomo≈õƒá fizyki teoretycznej', '2024-12-08 16:05:00'),
    (2, 6, 3, '3.5', 1, 1, 1, 'Poprawnie zaprojektowana baza danych', '2024-12-14 13:15:00'),
    (3, 1, 1, '5.0', 1, 1, 1, 'Wybitna znajomo≈õƒá programowania, kreatywne rozwiƒÖzania', '2024-12-15 10:40:00'),
    (3, 5, 2, '5.0', 1, 1, 2, 'Perfekcyjna znajomo≈õƒá analizy matematycznej', '2024-12-09 12:30:00'),
    (1, 1, 1, '4.0', 2, 1, 1, 'Kolokwium - dobry wynik', '2024-11-20 09:15:00'),
    (2, 1, 1, '2.0', 2, 1, 1, 'Pierwsze kolokwium - nieudane', '2024-11-20 09:20:00'),
    (2, 1, 1, '3.5', 2, 2, 1, 'Poprawa kolokwium - znacznie lepiej', '2024-12-05 09:15:00'),
    (3, 5, 2, '4.5', 2, 1, 2, 'Kolokwium z analizy - bardzo dobrze', '2024-11-15 10:00:00'),
    (1, 2, 1, 'ZAL', 1, 1, 1, 'Zaliczenie laboratorium - wszystkie zadania wykonane', '2024-12-20 15:00:00'),
    (2, 2, 1, 'ZAL', 1, 1, 1, 'Zaliczenie laboratorium', '2024-12-20 15:05:00'),
    (3, 1, 1, 'ZAL', 1, 1, 1, 'Zaliczenie przedmiotu przed egzaminem', '2024-12-20 15:10:00'),
    (2, 3, 4, 'NZAL', 1, 1, 1, 'Nie zaliczono - brak oddanych zada≈Ñ', '2024-11-30 16:00:00'),
    (2, 3, 4, '3.0', 1, 2, 1, 'Poprawa - zadania uzupe≈Çnione', '2024-12-18 16:00:00')
    ON CONFLICT (album_nr, class_id, attempt) DO NOTHING;

    SELECT 'Dane relacji zosta≈Çy pomy≈õlnie za≈Çadowane!' as success_message;
---
apiVersion: batch/v1
kind: Job
metadata:
  name: seed-db
  namespace: usosweb
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 3
  template:
    spec:
      imagePullSecrets:
      - name: ghcr-secret
      restartPolicy: OnFailure
      volumes:
      - name: sql-scripts
        configMap:
          name: seed-sql-scripts
      
      initContainers:
      # 1. Wait for PostgreSQL
      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL..."
          until pg_isready -h postgres-service -U postgres; do
            echo "PostgreSQL not ready, waiting..."
            sleep 3
          done
          echo "‚úÖ PostgreSQL is ready!"
      
      # 2. Run mock_data.sql (base data)
      - name: seed-mock-data
        image: postgres:15-alpine
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        volumeMounts:
        - name: sql-scripts
          mountPath: /scripts
        command:
        - sh
        - -c
        - |
          echo "üì¶ Loading mock_data.sql..."
          psql -h postgres-service -U postgres -d usosweb -f /scripts/mock_data.sql
          echo "‚úÖ mock_data.sql loaded!"
      
      # 3. Wait for API Gateway
      - name: wait-for-api-gateway
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          echo "Waiting for API Gateway..."
          until nc -z api-gateway-service 8083; do
            echo "API Gateway not ready, waiting..."
            sleep 5
          done
          sleep 10
          echo "‚úÖ API Gateway is ready!"
      
      # 4. Register users via API
      - name: init-users
        image: ghcr.io/slomus/usosweb-init-users:latest
        imagePullPolicy: Always
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      
      # Main container: Run init_relations.sql
      containers:
      - name: seed-relations
        image: postgres:15-alpine
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        volumeMounts:
        - name: sql-scripts
          mountPath: /scripts
        command:
        - sh
        - -c
        - |
          echo "üì¶ Loading init_relations.sql..."
          psql -h postgres-service -U postgres -d usosweb -f /scripts/init_relations.sql
          echo "‚úÖ init_relations.sql loaded!"
          echo ""
          echo "=========================================="
          echo "  ‚úì Database seeding completed!"
          echo "=========================================="
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
---
# Optional: Generator job for additional data (91 users + more relations)
apiVersion: batch/v1
kind: Job
metadata:
  name: seed-db-generator
  namespace: usosweb
  annotations:
    description: "Optional job to generate additional test data (91 users + relations)"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      imagePullSecrets:
      - name: ghcr-secret
      restartPolicy: OnFailure
      
      initContainers:
      - name: wait-for-seed-db
        image: postgres:15-alpine
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        command:
        - sh
        - -c
        - |
          echo "Checking if base seeding is complete..."
          until psql -h postgres-service -U postgres -d usosweb -c "SELECT COUNT(*) FROM users WHERE COUNT(*) >= 8" 2>/dev/null; do
            echo "Waiting for base users to be created..."
            sleep 5
          done
          echo "‚úÖ Base seeding complete!"
      
      containers:
      - name: generator
        image: ghcr.io/slomus/usosweb-generator:latest
        imagePullPolicy: Always
        env:
        - name: DB_HOST
          value: "postgres-service"
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          value: "postgres"
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        - name: DB_NAME
          value: "usosweb"
        - name: API_URL
          value: "http://api-gateway-service:8083"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"

