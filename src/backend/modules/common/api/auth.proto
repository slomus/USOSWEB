syntax = 'proto3';

package modules.common.api;

import "google/api/annotations.proto";

option go_package = "github.com/slomus/USOSWEB/src/backend/common/gen/auth;auth";

// Wiadomo≈õci

message LoginRequest {
  string email = 10;
  string password = 11;
}

message LoginResponse {
  string message = 10;
  int64 expires_in = 11;
}

message LogoutRequest {
  string refresh_token = 10;
  string access_token = 11;
}

message LogoutResponse {
  bool success = 10;
  string message = 11;
}

message RegisterRequest {
  string email = 11;
  string password = 12;
  string name = 13;
  string surname = 14;
  string pesel = 15;
  string phone_nr = 16;
  string postal_address = 17;
  string registration_address = 18;
  string bank_account_nr = 19;
  string role = 20; // "student", "teacher", "admin"

  string degree = 21;
  string title = 22;
  int32 faculty_id = 23;

  string admin_role = 24;
  string email_app_password = 25; // optional: per-user mail app password (encrypted at rest)
}

message RegisterResponse {
  bool success = 10;
  string message = 11;
  int64 user_id = 12;
  UserData user_data = 13;
}

message UserData {
  int64 user_id = 10;
  string name = 11;
  string surname = 12;
  string email = 13;
  string pesel = 14;
  string phone_nr = 15;
  string postal_address = 16;
  string registration_address = 17;
  string bank_account_nr = 18;
  bool active = 19;
  string activation_date = 20;
  string role = 21;
}

message RefreshTokenRequest { string refresh_token = 10; }

message RefreshTokenResponse {
  string message = 10;
  int64 expires_in = 11;
}

message ForgotPasswordRequest { string email = 10; }

message ForgotPasswordResponse {
  bool success = 10;
  string message = 11;
}

message ResetPasswordRequest {
  string token = 10;
  string new_password = 11;
}

message ResetPasswordResponse {
  bool success = 10;
  string message = 11;
}

message GetUserNameRequest {}

message GetUserNameResponse {
  string username = 10;
  string message = 11;
  bool success = 12;
  int64 status = 13;
}

message HelloRequest {}

message HelloResponse { string message = 10; }

message UserSubject {
  int32 class_id = 1;
  string subject_name = 2;
}

message User {
  int64 user_id = 10;
  string name = 11;
  string surname = 12;
  string email = 13;
  bool active = 14;
  string role = 15; // "student", "teacher", "admin", "unknown"
  optional int64 album_nr = 17;
  optional int64 teaching_staff_id = 18;
  optional int64 administrative_staff_id = 19;
}

message GetUsersRequest {}

message GetUsersResponse {
  repeated User users = 10;
  bool success = 11;
  string message = 12;
  int64 status = 13;
}

message GetUserDataRequest {}

message GetUserDataResponse {
  User user = 10;
  bool success = 11;
  string message = 12;
  int64 status = 13;
}

message GetUserRoleRequest { int64 user_id = 10; }

message GetUserRoleResponse {
  string role = 10;
  bool success = 11;
  string message = 12;
  int64 status = 13;
}

message GetUserEditDataRequest { int64 user_id = 10; }

message GetUserEditDataResponse {
  int64 user_id = 10;
  string name = 11;
  string surname = 12;
  string email = 13;
  string phone_nr = 14;
  string registration_address = 15;
  string postal_address = 16;
  string bank_account_nr = 17;
  bool active = 18;
}

message UpdateUserDataRequest {
  int64 user_id = 1;

  optional string name = 2;
  optional string surname = 3;
  optional string password = 4;
  optional string email = 5;
  optional string phone_nr = 6;
  optional string registration_address = 7;
  optional string postal_address = 8;
  optional string bank_account_nr = 9;
  optional bool active = 10;
}

message UpdateUserDataResponse {
  bool success = 10;
  string message = 11;
  GetUserEditDataResponse updated_data = 12;
}

message SearchUsersRequest {
  optional string name = 10;
  optional string surname = 11;
  optional string email = 12;
  optional string pesel = 13;
  optional string phone_nr = 14;
  optional bool active = 15;

  int32 page = 16;
  int32 page_size = 17;
}

message SearchUsersResponse {
  repeated UserSearchResult users = 10;
  int32 total_count = 11;
  int32 page = 12;
  int32 page_size = 13;
  int32 total_pages = 14;
}

message UserSearchResult {
  int64 user_id = 10;
  string name = 11;
  string surname = 12;
  string email = 13;
  string pesel = 14;
  string phone_nr = 15;
  bool active = 16;
  string role = 17; // "student", "teacher", "admin"
}

message DeleteUserRequest {
  int64 user_id = 1;
}
message DeleteUserResponse {
  bool success = 1;
  string message = 2;
}


message UploadProfilePhotoRequest {
  string photo_data = 10;
  string mime_type = 11; 
}

message UploadProfilePhotoResponse {
  bool success = 10;
  string message = 11;
  string photo_url = 12;
}

message GetProfilePhotoRequest {
  int32 user_id = 10;
}

message GetProfilePhotoResponse {
  bytes photo_data = 10;
  string mime_type = 11;
}

message GetMyStudentsRequest {}

message GetMyStudentsResponse {
  repeated User students = 1;
  bool success = 2;
  string message = 3;
}


message GetUserInfoRequest {
  int64 user_id = 1;
}

message GetUserInfoResponse {
  int64 user_id = 1;
  string name = 2;
  string surname = 3;
  string email = 4;
  bool active = 5;
  string profile_photo_path = 6;
}


// Serwis

service AuthService {
  rpc Login(LoginRequest) returns (LoginResponse) {
    option (google.api.http) = {
      post : "/api/auth/login"
      body : "*"
    };
  }

  rpc Logout(LogoutRequest) returns (LogoutResponse) {
    option (google.api.http) = {
      post : "/api/auth/logout"
      body : "*"
    };
  }

  rpc Register(RegisterRequest) returns (RegisterResponse) {
    option (google.api.http) = {
      post : "/api/auth/register"
      body : "*"
    };
  }

  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse) {
    option (google.api.http) = {
      post : "/api/auth/refresh"
      body : "*"
    };
  }

  rpc ForgotPassword(ForgotPasswordRequest) returns (ForgotPasswordResponse) {
    option (google.api.http) = {
      post : "/api/auth/forgot-password"
      body : "*"
    };
  }

  rpc ResetPassword(ResetPasswordRequest) returns (ResetPasswordResponse) {
    option (google.api.http) = {
      post : "/api/auth/reset-password"
      body : "*"
    };
  }

  rpc GetUserName(GetUserNameRequest) returns (GetUserNameResponse) {
    option (google.api.http) = {
      get : "/api/auth/username"
    };
  }

  rpc GetUsers(GetUsersRequest) returns (GetUsersResponse) {
    option (google.api.http) = {
      get : "/api/auth/users"
    };
  }

  rpc GetUserData(GetUserDataRequest) returns (GetUserDataResponse) {
    option (google.api.http) = {
      get : "/api/auth/user"
    };
  }

  rpc GetUserRole(GetUserRoleRequest) returns (GetUserRoleResponse) {
    option (google.api.http) = {
      get : "/api/auth/role"
    };
  }

  rpc GetUserEditData(GetUserEditDataRequest)
      returns (GetUserEditDataResponse) {
    option (google.api.http) = {
      get : "/api/auth/edit/{user_id}"
    };
  }

  rpc UpdateUserData(UpdateUserDataRequest) returns (UpdateUserDataResponse) {
    option (google.api.http) = {
      put : "/api/auth/edit/{user_id}"
      body : "*"
    };
  }

  rpc SearchUsers(SearchUsersRequest) returns (SearchUsersResponse) {
    option (google.api.http) = {
      get : "/api/auth/search"
    };
  }

  rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse) {
    option (google.api.http) = {
      delete: "/api/auth/user/{user_id}"
    };
  }

  rpc UploadProfilePhoto(UploadProfilePhotoRequest) returns (UploadProfilePhotoResponse) {
    option (google.api.http) = {
      post: "/api/users/photo"
      body: "*"
    };
  }

  rpc GetProfilePhoto(GetProfilePhotoRequest) returns (GetProfilePhotoResponse) {
    option (google.api.http) = {
      get: "/api/users/{user_id}/photo"
    };
  }

  rpc GetMyStudents(GetMyStudentsRequest) returns (GetMyStudentsResponse) {
    option (google.api.http) = {
    get : "/api/teacher/students"
  };
}

  rpc GetUserInfo(GetUserInfoRequest) returns (GetUserInfoResponse) {

    option (google.api.http) = {
      get: "/api/info/user/{user_id}"
    };
  }
}

service AuthHello {
  rpc SayHello(HelloRequest) returns (HelloResponse) {
    option (google.api.http) = {
      get : "/api/hello"
    };
  }
}
